# Reactor Threads Switching Demo

–£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è, **–∫–∞–∫ Project Reactor —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫–∞–º–∏** –≤ Spring Boot WebFlux-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

–¶–µ–ª—å ‚Äî –Ω–∞–≥–ª—è–¥–Ω–æ —É–≤–∏–¥–µ—Ç—å:
- –≥–¥–µ –∏ –∫–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ —á–∞—Å—Ç–∏ —Ü–µ–ø–æ—á–∫–∏ `Mono`/`Flux`
- –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç `subscribeOn` –∏ `publishOn`
- –≤ –∫–∞–∫–∏—Ö –ø–æ—Ç–æ–∫–∞—Ö –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç Netty event-loop –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É
- —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É `Schedulers.parallel()` –∏ `Schedulers.boundedElastic()`
- –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ (Java 21+)

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å

–ü—Ä–æ–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ WebFlux-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å:

- –æ–¥–Ω–∏–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º `POST /users`
- —Å—É—â–Ω–æ—Å—Ç—å—é `UserEntity`
- R2DBC + in-memory H2
- –¥–≤—É–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏ —Å–µ—Ä–≤–∏—Å–∞ `UserService`:

    1. `UserServiceSimple` ‚Äî –ø–æ—á—Ç–∏ –±–µ–∑ —è–≤–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞–º–∏ + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `subscribeOn`
    2. `UserServiceWithThreadSwitch` ‚Äî —Å —è–≤–Ω—ã–º–∏ `subscribeOn(Schedulers.parallel())` –∏ `publishOn(Schedulers.boundedElastic())`

–í–µ–∑–¥–µ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏:

- `doOnSubscribe`, `doOnNext`, `doOnSuccess`
- `Thread.currentThread().getName()`
- `Thread.currentThread().isVirtual()`
- `.log()` –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ü–µ–ø–æ—á–∫–∏

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:

- –±–µ–∑ `subscribeOn` / `publishOn`
- —Ç–æ–ª—å–∫–æ `subscribeOn`
- `subscribeOn` ‚Üí `publishOn`
- `publishOn` ‚Üí `subscribeOn`
- –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–ª—è `boundedElastic` (`-Dreactor.schedulers.defaultBoundedElasticOnVirtualThreads=true`)
- —Ä–∞–∑–Ω—ã–µ schedulers (`parallel`, `boundedElastic`, `single`, `immediate`)

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã

1. **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–µ—Å—å –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ Netty event-loop**  
   `reactor-http-nio-X` / `webflux-http-nio-X` ‚Äî –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—Å—è —è–≤–Ω—ã–π `publishOn` –∏–ª–∏ `subscribeOn`.

2. **`subscribeOn` –≤–ª–∏—è–µ—Ç –Ω–∞ upstream (–≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ –ø–æ–¥–ø–∏—Å–∫—É)**
    - –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ø–æ—Ç–æ–∫ **–æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞** (`Mono.just`, `fromCallable` –∏ —Ç.–¥.)
    - –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç–æ–∏—Ç –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ü–µ–ø–æ—á–∫–∏ ‚Äî **–∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª–æ**
    - `doOnSubscribe` –æ–±—ã—á–Ω–æ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –ø–æ—Ç–æ–∫–µ **–ø–æ–¥–ø–∏—Å—á–∏–∫–∞** (Netty), –∞ –Ω–µ –Ω–∞ –Ω–æ–≤–æ–º

3. **`publishOn` –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ downstream**
    - –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç **–≤—Å—ë –ø–æ—Å–ª–µ —Å–µ–±—è**
    - –ù–µ —Ç—Ä–æ–≥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–∞

4. **–ü–æ—Ä—è–¥–æ–∫ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ**
    - `subscribeOn` ‚Üí `publishOn` ‚Äî —Å–∞–º—ã–π –ª–æ–≥–∏—á–Ω—ã–π –∏ —á–∞—Å—Ç—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
    - `publishOn` ‚Üí `subscribeOn` ‚Äî –ø–æ—á—Ç–∏ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ (subscribeOn –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç —É–∂–µ –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω–Ω—ã–π downstream)

5. **Schedulers –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö**

   | Scheduler          | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å                     | –¢–∏–ø –ø–æ—Ç–æ–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)    | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –≤ WebFlux                 |
   |--------------------|----------------------------------------|-------------------------------|----------------------------------------|
   | `parallel()`       | CPU-bound, –±—ã—Å—Ç—Ä—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è          | –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ (ForkJoinPool)  | `publishOn` –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö     |
   | `boundedElastic()` | blocking I/O, JDBC, –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏    | –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ –∏–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ | `subscribeOn` –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ + blocking |
   | `single()`         | –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | –æ–¥–∏–Ω –ø–æ—Ç–æ–∫                    | —Ä–µ–¥–∫–æ                                  |
   | `immediate()`      | –æ—Ç–ª–∞–¥–∫–∞, —Ç–µ—Å—Ç—ã (–±–µ–∑ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è)      | —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫                 | —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–∞—Ö                        |

6. **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ (Java 21+)**
    - –í–∫–ª—é—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è `boundedElastic` —á–µ—Ä–µ–∑ `-Dreactor.schedulers.defaultBoundedElasticOnVirtualThreads=true`
    - –ò–º–µ–Ω–∞ –ø–æ—Ç–æ–∫–æ–≤: `loomBoundedElastic-N`
    - `spring.threads.virtual.enabled=true` **–Ω–µ –≤–ª–∏—è–µ—Ç** –Ω–∞ Reactor
    - –û—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è blocking-–æ–±—ë—Ä—Ç–æ–∫ –∏ legacy-–∫–æ–¥–∞, –ø–æ—á—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ —Å–æ–∑–¥–∞—ë—Ç —Ç—ã—Å—è—á–∏ –ø–æ—Ç–æ–∫–æ–≤

7. **–í WebFlux –Ω–µ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å event-loop**
    - –î–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ `subscribeOn(boundedElastic)` ‚Üí –∑–∞–≤–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
    - –õ—É—á—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞: `subscribeOn(boundedElastic)` –ø–µ—Ä–µ–¥ blocking-–∫–æ–¥–æ–º

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. `mvn clean install`
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å: `mvn spring-boot:run`
   –∏–ª–∏ —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏:  
   `mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Dreactor.schedulers.defaultBoundedElasticOnVirtualThreads=true"`
4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å:  

5. –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –∏–º–µ–Ω–∞ –ø–æ—Ç–æ–∫–æ–≤ –∏ `isVirtual`

6. –ü–æ–º–µ–Ω—è—Ç—å `@Qualifier` –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –º–µ–∂–¥—É `userServiceSimple` –∏ `userServiceWithThreads`

7. –ü–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:
- —É–±—Ä–∞—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å `subscribeOn`/`publishOn`
- –ø–æ–º–µ–Ω—è—Ç—å schedulers
- –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏

## –ü–æ–ª–µ–∑–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- [Project Reactor Reference ‚Äî Schedulers](https://projectreactor.io/docs/core/release/reference/#schedulers)
- [Reactor Netty Threading Model](https://github.com/reactor/reactor-netty/wiki/Threading-Model)
- [Spring Boot + Virtual Threads](https://docs.spring.io/spring-boot/reference/features/virtual-threads.html)

–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —É—á–µ–±–Ω—ã—Ö —Ü–µ–ª—è—Ö ‚Äî –Ω–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.

–£–¥–∞—á–∏ –≤ –∏–∑—É—á–µ–Ω–∏–∏ Reactor! üöÄ